-#  distance: function(lat1, lon1, lat2, lon2) {
    var R = 6371;
    var a = 0.5 - Math.cos((lat2 - lat1) * Math.PI / 180)/2 +
          Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
          (1 - Math.cos((lon2 - lon1) * Math.PI / 180))/2;
    return R * 2 * Math.asin(Math.sqrt(a));
  }

:javascript
  var PageConfig = {
    localities: #{@localities.to_json}
  }


  $(function() {

    var geo = Object.create(GeoLocation);
    geo.init();

    var compute = Object.create(ComputeLocation);

    var updated_at = $.cookie('_updated_at');

    if(updated_at) {
      var   date = new Date();
      if (date.getTime() - updated_at > 600000) {
        updateLocationInfo();
        updateAddressInfo();
      } else {
        compute.updatePlaces();
        $('.btn-loc span').html($.cookie('_locality'));
      }
    } else {
      updateLocationInfo();
      updateAddressInfo();
    }

    function updateLocationInfo() {
      setTimeout(function() {
        if(__geoLoc__.error) {
          compute.manualLocation(
            'Failed: '+ __geoLoc__.error.message + '. Please select your location.'
          );
        } else {
          compute.init(
            new google.maps.Geocoder(),
            geo.result(),
            PageConfig.localities
          );

          compute.start();
        }
      }, 6000);
    }

    function updateAddressInfo() {
      setTimeout(function() {
        if(!__geoLoc__.error && __geoLoc__.position) {
          compute.updateAddress(
            compute.matchLocality(
              compute.results()[1].formatted_address
            )
          );
        }
      }, 7000);
    }

    $('#selectLocation .manual-loc').click(function() {
      $('#selectLocation .form-control').each(function() {
        if($(this).val()) {
          compute.setLocation($(this).val());
          $('#selectLocation').modal('toggle');
        } else {
          $(this).addClass('has-error');
        }
      });

    });

  });

