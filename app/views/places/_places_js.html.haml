:javascript
  var PageConfig = {
    localities: #{@localities.to_json}
  }

  $(function() {
    var geo = Object.create(GeoLocation);
    geo.init();

    var compute = Object.create(ComputeLocation);
    var updated_at = $.cookie('_updated_at');

    if(updated_at) {
      compute.updatePlaces();
      $('.btn-loc span').html($.cookie('_locality_name'));
      $('.results .result span').html('"'+$.cookie('_locality_name')+'"');
    } else {
      updateLocationInfo();
      updateAddressInfo();
    }

    function updateLocationInfo() {
      setTimeout(function() {
        if(__geoLoc__.error) {
          compute.manualLocation(
            'Failed: '+ __geoLoc__.error.message + '. Please select your location.'
          );
        } else {
          compute.init(
            new google.maps.Geocoder(),
            geo.result(),
            PageConfig.localities
          );

          compute.start();
        }
      }, 6000);
    }

    function updateAddressInfo() {
      setTimeout(function() {
        if(!__geoLoc__.error && __geoLoc__.position) {
          compute.updateAddress(
            compute.matchLocality(
              compute.results()[1].formatted_address
            )
          );
        }
      }, 7000);
    }

    $('#selectLocation .manual-loc').click(function() {
      $('#selectLocation .form-control').each(function() {
        if($(this).val()) {
          var id = $(this).val();
          var locality = PageConfig.localities.filter(function(l){ return l.id==id})[0];
          compute.setLocation(locality);
          $('#selectLocation').modal('toggle');
        } else {
          $(this).addClass('has-error');
        }
      });

    });

    $('.update-loc').click(function() {
      $('.btn-loc span').html('<span> Updating your location... <i class="fa fa-spin fa-spinner"></i></span>');
      $('#places .content').html('<div class="center-block"><p>Updating the list based on your location ...</p><i class="fa fa-spin fa-circle-o-notch"></i></div>');
      updateLocationInfo();
      updateAddressInfo();
    });

    $('.fake-input').click(function() {
      $('.content').toggle();
      var modal = $(this).closest('div').find('.modal')
      $(modal).toggle();
      $(modal).find('.search-input').focus();
    });

    $('button.close').click(function() {
      $(this).parents('.modal').toggle();
      $('.content').toggle();
    });

    $('.results').delegate('.result','click',function() {
      var kind, url,name,id;
      kind = $(this).attr('data-kind');
      url = $(this).attr('data-url');
      id = $(this).attr('data-id');
      name = $(this).html().split('<')[0];

      function toggleSearch() {
        $('.fake-input').html(name);
        $('#searchModal').toggle();
        $('.content').toggle();
      }

      switch (kind) {
      case "Place":
        window.location = url;
        break;
      case "Item":
        toggleSearch();
        compute.updatePlaces(name,'');
        break;
      case "Cuisine":
        toggleSearch();
        compute.updatePlaces('',id);
        break;
      }
    });

    $('.search-input').on('keyup',function() {
      $('.results').html('');
      $.get(
        '/searches/search',
        {
          search: $('.search-input').val(),
          locality: $.cookie('_locality_name')
        },
        function(data) {
          for(var i=0; i < data.length; i++) {
            var data_attrs = "data-url='"+ data[i].url + "' data-kind='" + data[i].kind +"' data-id='" + data[i].id + "'";
            $('.results').append(
              "<li class='result' "+ data_attrs +"'>" + data[i].name + "<span class='kind'>" + data[i].kind + "</li>"
            );
          }
        }
      );
    });

  });

